<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="R-HScnlw-ZhXn-Yr85vmhjpz9iX1eCh1qW0RWEVAhkc" />
    <title>Dream Dwellings</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --background: #f9fafb; --text-primary: #1f2937; --text-secondary: #4b5563; --card-bg: #ffffff; --border-color: #e5e7eb; }
        html.dark { --background: #111827; --text-primary: #f9fafb; --text-secondary: #9ca3af; --card-bg: #1f2937; --border-color: #374151; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--background); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; }
        .hero-bg { background-image: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('https://images.unsplash.com/photo-1568605114967-8130f3a36994?q=80&w=2070&auto=format&fit=crop'); background-size: cover; background-position: center; }
        .login-bg { background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('https://images.unsplash.com/photo-1583608205776-bfd35f0d9f83?q=80&w=2070&auto=format&fit=crop'); background-size: cover; background-position: center; }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); }
        .chat-widget { transition: all 0.3s ease-in-out; }
        .chat-messages::-webkit-scrollbar { width: 4px; }
        .chat-messages::-webkit-scrollbar-thumb { background-color: #90A4AE; border-radius: 20px; }
        .dark .chat-messages::-webkit-scrollbar-thumb { background-color: #4b5563; }
        .toggle-bg:after { content: ''; @apply absolute top-0.5 left-0.5 bg-white border border-gray-300 rounded-full h-5 w-5 transition-transform shadow-sm; }
        input:checked + .toggle-bg:after { @apply transform translate-x-full; }
        input:checked + .toggle-bg { @apply bg-blue-600; }
        .profile-avatar-overlay { transition: opacity 0.2s ease-in-out; }
    </style>
    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100">

    <div id="root"></div>
    
    <script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

// --- FIREBASE INITIALIZATION ---
const firebaseConfig = {
    apiKey: "AIzaSyDI-h_INRPzbhtDmPMsf3sBvm14F8TolDw",
    authDomain: "easten-website.firebaseapp.com",
    projectId: "easten-website",
    storageBucket: "easten-website.appspot.com",
    messagingSenderId: "600065302945",
    appId: "1:600065302945:web:d69ddae873ab5df0862be0",
    databaseURL: "https://easten-website-default-rtdb.firebaseio.com"
};

if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}

const auth = firebase.auth();
const firestore = firebase.firestore();
const storage = firebase.storage(); 
const database = firebase.database();

// --- PRESENCE HOOK ---
const useUserStatus = (userId) => {
    const [isOnline, setIsOnline] = useState(false);

    useEffect(() => {
        if (!userId) {
            setIsOnline(false);
            return;
        }

        const userStatusRef = database.ref('/status/' + userId);
        
        const onStatusChange = (snapshot) => {
            if (snapshot.exists()) {
                const status = snapshot.val();
                setIsOnline(status.state === 'online');
            } else {
                setIsOnline(false);
            }
        };

        userStatusRef.on('value', onStatusChange);

        return () => {
            userStatusRef.off('value', onStatusChange);
        };
    }, [userId]);

    return isOnline;
};


// --- CLOUDINARY IMAGE UPLOAD UTILITY ---
const CLOUDINARY_CLOUD_NAME = "dvvwqio1d";
const CLOUDINARY_UPLOAD_PRESET = "estate";

const uploadImageToCloudinary = async (file) => {
    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);
    formData.append("folder", "estate_images");

    try {
        const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
            method: "POST",
            body: formData
        });
        const data = await response.json();
        if (response.ok) {
            return data.secure_url;
        } else {
            console.error("Cloudinary upload error:", data);
            return null;
        }
    } catch (error) {
        console.error("Error uploading image:", error);
        return null;
    }
};

// --- AUTHENTICATION COMPONENT ---
const LoginSignUp = () => {
    const [isLogin, setIsLogin] = useState(true);
    const [name, setName] = useState('');
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [error, setError] = useState('');
    const [loading, setLoading] = useState(false);

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        if (!isLogin && !name) {
            setError("Name is required for sign up.");
            setLoading(false);
            return;
        }

        try {
            if (isLogin) {
                await auth.signInWithEmailAndPassword(email, password);
            } else {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                await user?.updateProfile({ displayName: name });
                // Create user document in Firestore
                await firestore.collection('users').doc(user.uid).set({
                    uid: user.uid,
                    displayName: name,
                    email: user.email,
                    photoURL: user.photoURL,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        } catch (err) {
            setError(err.message);
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="min-h-screen flex items-center justify-center login-bg p-4">
            <div className="max-w-md w-full bg-white p-8 rounded-xl shadow-2xl dark:bg-gray-800">
                <div className="text-center mb-8">
                    <div className="inline-flex items-center justify-center bg-blue-100 dark:bg-blue-900/50 p-3 rounded-full mb-4">
                         <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8 text-blue-600 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                            <path strokeLinecap="round" strokeLinejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                        </svg>
                    </div>
                    <h1 className="text-3xl font-bold text-gray-800 dark:text-gray-100">Dream Dwellings</h1>
                </div>
                <h2 className="text-2xl font-bold text-center text-gray-800 dark:text-gray-100 mb-2">{isLogin ? 'Welcome Back' : 'Create an Account'}</h2>
                <p className="text-center text-gray-500 dark:text-gray-400 mb-6">{isLogin ? 'Login to continue your journey' : 'Find your dream home with us'}</p>
                {error && <p className="bg-red-100 text-red-700 p-3 rounded-md mb-4 text-sm dark:bg-red-900/50 dark:text-red-300">{error}</p>}
                <form onSubmit={handleSubmit} className="space-y-6">
                    {!isLogin && (
                        <div>
                            <label htmlFor="name" className="block text-sm font-medium text-gray-700 dark:text-gray-300">Full Name</label>
                            <input type="text" id="name" value={name} onChange={e => setName(e.target.value)} required className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"/>
                        </div>
                    )}
                    <div>
                        <label htmlFor="email" className="block text-sm font-medium text-gray-700 dark:text-gray-300">Email Address</label>
                        <input type="email" id="email" value={email} onChange={e => setEmail(e.target.value)} required className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"/>
                    </div>
                    <div>
                        <label htmlFor="password"className="block text-sm font-medium text-gray-700 dark:text-gray-300">Password</label>
                        <input type="password" id="password" value={password} onChange={e => setPassword(e.target.value)} required className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"/>
                    </div>
                    <button type="submit" disabled={loading} className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 flex items-center justify-center disabled:bg-blue-400">
                        {loading ? <span className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></span> : (isLogin ? 'Login' : 'Sign Up')}
                    </button>
                </form>
                <p className="text-center text-sm text-gray-600 dark:text-gray-400 mt-8">
                    {isLogin ? "Don't have an account?" : "Already have an account?"}
                    <button onClick={() => { setIsLogin(!isLogin); setError(''); }} className="font-medium text-blue-600 hover:underline ml-1 dark:text-blue-400">
                        {isLogin ? 'Sign up' : 'Login'}
                    </button>
                </p>
            </div>
        </div>
    );
};


// --- MAIN APP COMPONENTS ---

const Header = ({ user, onSellClick, onInboxClick, hasUnreadMessages, onEditProfile, onLogout }) => {
    const [dropdownOpen, setDropdownOpen] = useState(false);
    const dropdownRef = useRef(null);

    useEffect(() => {
        const handleClickOutside = (event) => {
            if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                setDropdownOpen(false);
            }
        };
        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
    }, []);

    const userInitial = user.displayName ? user.displayName.charAt(0).toUpperCase() : '?';

    return (
        <header className="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-50">
            <nav className="container mx-auto px-6 py-4 flex justify-between items-center">
                <a href="#" onClick={(e) => { e.preventDefault(); window.location.reload(); }} className="flex items-center text-2xl font-bold text-blue-600 dark:text-blue-400">
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                        <path strokeLinecap="round" strokeLinejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>
                    <span>Dream Dwellings</span>
                </a>
                <div className="flex items-center space-x-4">
                     <button onClick={onInboxClick} className="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600 transition relative">
                        Inbox
                        {hasUnreadMessages && <span className="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-white dark:border-gray-800"></span>}
                    </button>
                     <button onClick={onSellClick} className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition">Sell Property</button>
                     <div className="relative" ref={dropdownRef}>
                        <button onClick={() => setDropdownOpen(prev => !prev)} className="flex items-center space-x-2">
                            <div className="relative w-8 h-8 rounded-full bg-blue-200 dark:bg-blue-900 flex items-center justify-center text-blue-600 dark:text-blue-300 font-bold overflow-hidden">
                                {user.photoURL ? <img src={user.photoURL} alt="Profile" className="w-full h-full object-cover" /> : <span>{userInitial}</span>}
                                <span className="absolute bottom-0 right-0 block h-2.5 w-2.5 rounded-full bg-green-400 ring-2 ring-white dark:ring-gray-800" title="Online"></span>
                            </div>
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-gray-600 dark:text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clipRule="evenodd" /></svg>
                        </button>
                        {dropdownOpen && (
                            <div className="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-700 rounded-md shadow-xl z-20">
                                <div className="px-4 py-3 border-b dark:border-gray-600">
                                    <p className="text-sm text-gray-800 dark:text-gray-200 font-semibold">{user.displayName}</p>
                                    <p className="text-xs text-gray-500 dark:text-gray-400 truncate">{user.email}</p>
                                </div>
                                <a href="#" onClick={(e) => { e.preventDefault(); onEditProfile(); setDropdownOpen(false); }} className="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">Edit Profile</a>
                                <a href="#" onClick={(e) => { e.preventDefault(); setDropdownOpen(false); onLogout(); }} className="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">Logout</a>
                            </div>
                        )}
                     </div>
                </div>
            </nav>
        </header>
    );
};

const Hero = () => (
    <section className="hero-bg text-white h-96 flex items-center">
        <div className="container mx-auto px-6 text-center">
            <h1 className="text-5xl font-bold mb-4">Find Your Dream Home</h1>
            <p className="text-xl">We help you find the perfect place to call home. Your journey starts here.</p>
        </div>
    </section>
);

const PropertyCard = ({ property, onContact, onViewDetails, onEdit, onDelete }) => {
    const isOwner = auth.currentUser?.uid === property.userId;

    const handleContactClick = (e) => { e.stopPropagation(); onContact(property); };
    const handleEditClick = (e) => { e.stopPropagation(); onEdit(property); };
    const handleDeleteClick = (e) => { e.stopPropagation(); onDelete(property); };

    const imageUrl = (property.imageUrls && property.imageUrls.length > 0 && property.imageUrls[0])
        ? property.imageUrls[0]
        : `https://via.placeholder.com/400x300.png?text=No+Image+Available`;

    return (
        <div onClick={() => onViewDetails(property.id)} className="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden transform hover:-translate-y-2 transition-transform duration-300 flex flex-col cursor-pointer">
            <img src={imageUrl} alt={property.title || 'Property Image'} className="w-full h-56 object-cover bg-gray-200 dark:bg-gray-700" />
            <div className="p-6 flex flex-col flex-grow">
                <h3 className="text-2xl font-bold mb-2 text-gray-800 dark:text-gray-100">{property.title || 'Untitled Property'}</h3>
                <p className="text-gray-600 dark:text-gray-400 mb-4">{property.address || 'No address provided'}</p>
                <p className="text-lg font-semibold text-blue-600 dark:text-blue-400 mb-4">${Number(property.price || 0).toLocaleString()}</p>
                <p className="text-gray-700 dark:text-gray-300 mb-4 flex-grow">{((property.description || '').substring(0, 100) + '...').replace('...', property.description.length > 100 ? '...' : '')}</p>
                <div className="border-t dark:border-gray-700 pt-4 flex justify-between items-center">
                    <span className={`text-sm font-medium ${property.listingType === 'For Sale' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' : 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300'} px-3 py-1 rounded-full`}>{property.listingType}</span>
                    {!isOwner && <button onClick={handleContactClick} className="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition text-sm">Contact Seller</button>}
                    {isOwner && (
                        <div className="space-x-2">
                            <button onClick={handleEditClick} className="bg-yellow-500 text-white px-3 py-1 rounded-md hover:bg-yellow-600 transition text-sm">Edit</button>
                            <button onClick={handleDeleteClick} className="bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600 transition text-sm">Delete</button>
                        </div>
                    )}
                </div>
            </div>
        </div>
    )
};

const FeaturedProperties = ({ onContactSeller, onViewDetails, onEditProperty, onDeleteProperty }) => {
    const [properties, setProperties] = useState([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const unsubscribe = firestore.collection("properties").orderBy("createdAt", "desc")
            .onSnapshot(
                (snapshot) => {
                    const props = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setProperties(props);
                    setLoading(false);
                },
                (err) => { 
                    console.error("Firestore snapshot error:", err); 
                    setLoading(false);
                }
            );
        return () => unsubscribe();
    }, []);

    return (
        <main className="py-12 bg-gray-50 dark:bg-gray-900">
            <h2 className="text-3xl font-bold text-center mb-10 dark:text-gray-100">Featured Properties</h2>
            <div className="container mx-auto px-4">
                {loading ? (
                     <div className="flex justify-center items-center h-64">
                        <div className="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
                     </div>
                ) : (
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        {properties.length > 0 ? (
                            properties.map((property) => (
                                <PropertyCard 
                                    key={property.id} 
                                    property={property} 
                                    onContact={onContactSeller}
                                    onViewDetails={onViewDetails}
                                    onEdit={onEditProperty}
                                    onDelete={onDeleteProperty}
                                />
                            ))
                        ) : (
                            <p className="text-center col-span-full text-gray-500 dark:text-gray-400">No properties listed yet. Be the first to sell!</p>
                        )}
                    </div>
                )}
            </div>
        </main>
    );
};

const WhyChooseUs = () => (
    <section className="py-16 bg-white dark:bg-gray-800">
        <div className="container mx-auto px-6">
            <h2 className="text-3xl font-bold text-center mb-10">Why Choose Us?</h2>
            <div className="grid md:grid-cols-3 gap-8 text-center">
                <div className="p-6">
                    <div className="inline-block bg-blue-100 text-blue-600 p-4 rounded-full mb-4 dark:bg-blue-900/50 dark:text-blue-400">
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01" /></svg>
                    </div>
                    <h3 className="text-xl font-semibold mb-2">Best Prices</h3>
                    <p className="text-gray-600 dark:text-gray-400">We offer competitive pricing on all our properties, ensuring you get the best value for your investment.</p>
                </div>
                <div className="p-6">
                    <div className="inline-block bg-blue-100 text-blue-600 p-4 rounded-full mb-4 dark:bg-blue-900/50 dark:text-blue-400">
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </div>
                    <h3 className="text-xl font-semibold mb-2">Trusted by Thousands</h3>
                    <p className="text-gray-600 dark:text-gray-400">Our reputation is built on trust and customer satisfaction. Join our community of happy homeowners.</p>
                </div>
                <div className="p-6">
                    <div className="inline-block bg-blue-100 text-blue-600 p-4 rounded-full mb-4 dark:bg-blue-900/50 dark:text-blue-400">
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9V3" /></svg>
                    </div>
                    <h3 className="text-xl font-semibold mb-2">Wide Range of Properties</h3>
                    <p className="text-gray-600 dark:text-gray-400">From cozy apartments to luxurious villas, we have a diverse portfolio to match every lifestyle and budget.</p>
                </div>
            </div>
        </div>
    </section>
);


const Footer = () => (
    <footer className="bg-gray-800 text-white dark:bg-gray-900">
        <div className="container mx-auto px-6 py-8">
            <div className="flex flex-col sm:flex-row justify-between items-center text-center sm:text-left">
                <div className="flex items-center text-lg font-bold">
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 mr-2 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                        <path strokeLinecap="round" strokeLinejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>
                    <span>Dream Dwellings</span>
                </div>
                <p className="text-sm mt-4 sm:mt-0">&copy; {new Date().getFullYear()} Dream Dwellings. All rights reserved.</p>
            </div>
        </div>
    </footer>
);


const SellPropertyModal = ({ isOpen, onClose, onPropertyListed, propertyToEdit }) => {
    const [title, setTitle] = useState('');
    const [address, setAddress] = useState('');
    const [price, setPrice] = useState('');
    const [description, setDescription] = useState('');
    const [listingType, setListingType] = useState('For Sale');
    const [imageUrls, setImageUrls] = useState([]);
    const [uploading, setUploading] = useState(false);
    const [error, setError] = useState('');
    const [loading, setLoading] = useState(false);

    useEffect(() => {
        if (propertyToEdit) {
            setTitle(propertyToEdit.title || '');
            setAddress(propertyToEdit.address || '');
            setPrice(propertyToEdit.price || '');
            setDescription(propertyToEdit.description || '');
            setListingType(propertyToEdit.listingType || 'For Sale');
            setImageUrls(propertyToEdit.imageUrls || []);
        } else {
            setTitle('');
            setAddress('');
            setPrice('');
            setDescription('');
            setListingType('For Sale');
            setImageUrls([]);
        }
    }, [propertyToEdit, isOpen]); 


    const handleImageChange = async (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;
        setUploading(true);
        setError('');

        const uploadedUrls = await Promise.all(
            files.map(file => uploadImageToCloudinary(file))
        );
        
        const successfulUrls = uploadedUrls.filter(url => url !== null);

        if (successfulUrls.length < files.length) {
            setError("Some images failed to upload. Please try again.");
        }
        
        setImageUrls(prev => [...prev, ...successfulUrls]);
        setUploading(false);
    };

    const removeImage = (index) => {
        setImageUrls(prev => prev.filter((_, i) => i !== index));
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        if (!title || !price || !address || !description) {
            setError("Please fill in all required fields.");
            return;
        }
        setLoading(true);

        const propertyData = {
            title,
            address,
            price: parseFloat(price),
            description,
            listingType,
            imageUrls,
            userId: auth.currentUser.uid,
            userName: auth.currentUser.displayName
        };
        
        try {
            if (propertyToEdit) {
                await firestore.collection("properties").doc(propertyToEdit.id).update(propertyData);
            } else {
                await firestore.collection("properties").add({
                    ...propertyData,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            onPropertyListed();
            onClose();
        } catch (err) {
            console.error(err);
            setError("Failed to save property. Please try again.");
        } finally {
            setLoading(false);
        }
    };
    
    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
            <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <div className="flex justify-between items-center mb-4">
                    <h2 className="text-2xl font-bold">{propertyToEdit ? 'Edit Property' : 'Sell Your Property'}</h2>
                    <button onClick={onClose} className="text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 text-2xl">&times;</button>
                </div>

                {error && <p className="bg-red-100 text-red-700 p-3 rounded-md mb-4 text-sm dark:bg-red-900/50 dark:text-red-300">{error}</p>}

                <form onSubmit={handleSubmit} className="space-y-4">
                    <input type="text" placeholder="Property Title" value={title} onChange={e => setTitle(e.target.value)} required className="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" />
                    <input type="text" placeholder="Address" value={address} onChange={e => setAddress(e.target.value)} required className="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" />
                    <input type="number" placeholder="Price (USD)" value={price} onChange={e => setPrice(e.target.value)} required className="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" />
                    <textarea placeholder="Description" value={description} onChange={e => setDescription(e.target.value)} required className="w-full p-2 border rounded h-24 dark:bg-gray-700 dark:border-gray-600"></textarea>
                    
                    <div>
                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Listing Type</label>
                        <select value={listingType} onChange={e => setListingType(e.target.value)} className="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                            <option>For Sale</option>
                            <option>For Rent</option>
                        </select>
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Upload Images</label>
                        <input type="file" multiple onChange={handleImageChange} accept="image/*" className="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 dark:file:bg-gray-700 dark:file:text-gray-300 dark:hover:file:bg-gray-600" />
                    </div>

                    {uploading && <p className="text-blue-500 dark:text-blue-400">Uploading images...</p>}

                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                        {imageUrls.map((url, index) => (
                            <div key={index} className="relative group">
                                <img src={url} alt={`Property image ${index + 1}`} className="w-full h-24 object-cover rounded-md" />
                                <button type="button" onClick={() => removeImage(index)} className="absolute top-1 right-1 bg-red-600 text-white rounded-full h-5 w-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity">&times;</button>
                            </div>
                        ))}
                    </div>

                    <div className="flex justify-end space-x-4">
                        <button type="button" onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500">Cancel</button>
                        <button type="submit" disabled={loading || uploading} className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-blue-400">
                            {loading ? 'Saving...' : (propertyToEdit ? 'Save Changes' : 'List Property')}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};

const PropertyDetailsPage = ({ propertyId, onBack, onContactSeller }) => {
    const [property, setProperty] = useState(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState('');
    const [selectedImage, setSelectedImage] = useState(null);

    useEffect(() => {
        if (!propertyId) return;
        setLoading(true);
        const unsubscribe = firestore.collection("properties").doc(propertyId)
            .onSnapshot(doc => {
                if (doc.exists) {
                    const propData = { id: doc.id, ...doc.data() };
                    setProperty(propData);
                    setSelectedImage(propData.imageUrls && propData.imageUrls.length > 0 ? propData.imageUrls[0] : null);
                } else {
                    setError("Property not found.");
                }
                setLoading(false);
            }, err => {
                console.error(err);
                setError("Failed to load property details.");
                setLoading(false);
            });

        return () => unsubscribe();
    }, [propertyId]);

    if (loading) return <div className="flex justify-center items-center h-screen"><div className="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-blue-500"></div></div>;
    if (error) return <div className="text-center py-10 text-red-500">{error}</div>;
    if (!property) return null;
    
    const isOwner = auth.currentUser?.uid === property.userId;

    const imageUrl = (property.imageUrls && property.imageUrls.length > 0 && property.imageUrls[0]) 
        ? property.imageUrls[0] 
        : `https://via.placeholder.com/800x600.png?text=No+Image+Available`;

    return (
        <div className="container mx-auto px-4 py-8">
            <button onClick={onBack} className="mb-6 bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600 transition">
                &larr; Back to Listings
            </button>
            
            <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl overflow-hidden">
                <div className="grid grid-cols-1 md:grid-cols-3 gap-0">
                    <div className="md:col-span-2">
                        <img src={selectedImage || imageUrl} alt={property.title || 'Main property view'} className="w-full h-[500px] object-cover bg-gray-200 dark:bg-gray-700" />
                        
                        {property.imageUrls && property.imageUrls.length > 1 && (
                            <div className="p-4 bg-gray-100 dark:bg-gray-900 flex space-x-2 overflow-x-auto">
                                {property.imageUrls.map((url, index) => (
                                    <img 
                                        key={index}
                                        src={url}
                                        alt={`Thumbnail ${index + 1}`}
                                        className={`w-24 h-24 object-cover rounded-md cursor-pointer border-2 ${selectedImage === url ? 'border-blue-500' : 'border-transparent'}`}
                                        onClick={() => setSelectedImage(url)}
                                    />
                                ))}
                            </div>
                        )}
                    </div>
                    
                    <div className="p-6 flex flex-col">
                        <h1 className="text-4xl font-bold mb-2">{property.title || 'Untitled Property'}</h1>
                        <p className="text-gray-600 dark:text-gray-400 text-lg mb-4">{property.address || 'No address provided'}</p>
                        
                        <div className="my-4">
                            <span className={`text-lg font-medium ${property.listingType === 'For Sale' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' : 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300'} px-4 py-2 rounded-full`}>{property.listingType}</span>
                        </div>
                        
                        <p className="text-3xl font-bold text-blue-600 dark:text-blue-400 my-4">${Number(property.price || 0).toLocaleString()}</p>
                        
                        <div className="mt-4 flex-grow">
                            <h3 className="text-xl font-semibold mb-2">Description</h3>
                            <p className="text-gray-700 dark:text-gray-300 whitespace-pre-wrap">{property.description || 'No description available.'}</p>
                        </div>
                        
                        <div className="border-t dark:border-gray-700 pt-4 mt-6">
                            <p className="text-sm text-gray-500 dark:text-gray-400">Listed by: {property.userName || 'Unknown Seller'}</p>
                            {!isOwner && (
                                <button onClick={() => onContactSeller(property)} className="mt-4 w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                                    Contact Seller
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};

const ConversationListItem = ({ convo, onConversationSelect }) => {
    const isOtherUserOnline = useUserStatus(convo.otherUser?.uid);
    
    if (!convo || !convo.otherUser) {
        return null;
    }

    return (
        <div 
            onClick={() => onConversationSelect(convo.id, convo.property, convo.otherUser)} 
            className="p-4 bg-white dark:bg-gray-800 rounded-lg shadow hover:shadow-md cursor-pointer transition"
        >
            <div className="flex items-center space-x-2">
                <p className="font-bold text-lg">{convo.otherUser.displayName || 'Unknown User'}</p>
                {isOtherUserOnline && <span className="w-2.5 h-2.5 bg-green-400 rounded-full" title="Online"></span>}
            </div>
            <p className="text-gray-600 dark:text-gray-400">Regarding: {(convo.property && convo.property.title) || 'N/A'}</p>
            <p className="text-sm text-gray-500 dark:text-gray-500 mt-2">
                {convo.lastMessage && convo.lastMessage.text 
                    ? `Last message: ${convo.lastMessage.text.substring(0, 30)}...` 
                    : 'No messages yet'}
            </p>
        </div>
    );
};

const InboxPage = ({ onConversationSelect, onBack }) => {
    const [conversations, setConversations] = useState([]);
    const [loading, setLoading] = useState(true);
    const currentUser = auth.currentUser;

    useEffect(() => {
        if (!currentUser) return;

        const conversationsRef = firestore.collection('chats').where('participants', 'array-contains', currentUser.uid);

        const unsubscribe = conversationsRef.onSnapshot(async (snapshot) => {
            setLoading(true);
            try {
                const convosPromises = snapshot.docs.map(async (doc) => {
                    const data = doc.data();
                    
                    if (!Array.isArray(data.participants)) {
                        console.error(`Chat document ${doc.id} has malformed participants field.`);
                        return null; 
                    }

                    const otherParticipantId = data.participants.find(p => p !== currentUser.uid);

                    let otherUser = { displayName: 'Unknown User', photoURL: null, uid: otherParticipantId };
                    if (otherParticipantId) {
                        try {
                            const userDoc = await firestore.collection('users').doc(otherParticipantId).get();
                            if (userDoc.exists) {
                                otherUser = userDoc.data();
                            }
                        } catch (userError) {
                            console.error(`Failed to fetch user ${otherParticipantId}`, userError);
                        }
                    }

                    let property = { 
                        title: 'Property no longer available', 
                        id: data.propertyId,
                        userId: null, 
                        userName: 'N/A' 
                    };
                    if (data.propertyId) {
                        try {
                            const propDoc = await firestore.collection('properties').doc(data.propertyId).get();
                            if (propDoc.exists) {
                                property = { id: propDoc.id, ...propDoc.data() };
                            }
                        } catch (propError) {
                            console.error(`Failed to fetch property ${data.propertyId}`, propError);
                        }
                    }

                    return {
                        id: doc.id,
                        ...data,
                        otherUser,
                        property,
                    };
                });

                const resolvedConvos = (await Promise.all(convosPromises)).filter(Boolean);
                setConversations(resolvedConvos);
            } catch (error) {
                console.error("Error processing conversations snapshot:", error);
            } finally {
                setLoading(false);
            }
        }, (error) => {
            console.error("Firestore listener error:", error);
            setLoading(false);
        });

        return () => unsubscribe();
    }, [currentUser]);

    if (loading) return <div className="flex justify-center items-center h-64"><div className="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div></div>;

    return (
        <div className="container mx-auto p-4">
             <button onClick={onBack} className="mb-6 bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600 transition">
                &larr; Back to Home
            </button>
            <h1 className="text-3xl font-bold mb-6">Inbox</h1>
            {conversations.length > 0 ? (
                <div className="space-y-4">
                    {conversations.map(convo => (
                        <ConversationListItem 
                           key={convo.id}
                           convo={convo}
                           onConversationSelect={onConversationSelect}
                        />
                    ))}
                </div>
            ) : (
                <p>No conversations yet.</p>
            )}
        </div>
    );
};

const ChatWidget = ({ property, recipientInfo, onClose, conversationId: initialConversationId, onNewMessage }) => {
    const [messages, setMessages] = useState([]);
    const [newMessage, setNewMessage] = useState('');
    const [conversationId, setConversationId] = useState(initialConversationId);
    const [loading, setLoading] = useState(false);
    const currentUser = auth.currentUser;
    const messagesEndRef = useRef(null);
    const isRecipientOnline = useUserStatus(recipientInfo?.uid);

    const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
    };

    useEffect(() => {
        if (!conversationId) return;

        const unsubscribe = firestore.collection('chats').doc(conversationId).collection('messages')
            .orderBy('timestamp', 'asc')
            .onSnapshot(snapshot => {
                const msgs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setMessages(msgs);
            });

        return () => unsubscribe();
    }, [conversationId]);
    
    useEffect(scrollToBottom, [messages]);
    
    // Effect to mark messages as read
    useEffect(() => {
        if (!conversationId || !currentUser || messages.length === 0) return;

        const messagesToUpdate = messages
            .filter(msg => msg.senderId !== currentUser.uid && !msg.readBy?.includes(currentUser.uid))
            .map(msg => msg.id);

        if (messagesToUpdate.length > 0) {
            const batch = firestore.batch();
            messagesToUpdate.forEach(messageId => {
                const msgRef = firestore.collection('chats').doc(conversationId).collection('messages').doc(messageId);
                batch.update(msgRef, {
                    readBy: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                });
            });

            batch.commit().catch(err => {
                console.error("Failed to mark messages as read:", err);
            });
        }
    }, [messages, conversationId, currentUser]);


    const findOrCreateConversation = async () => {
        if (conversationId) return conversationId;
        if (!property || !property.id) return null;
        
        const sellerId = property.userId;
        const buyerId = currentUser.uid;

        const querySnapshot = await firestore.collection('chats')
          .where('propertyId', '==', property.id)
          .where('participants', 'in', [[buyerId, sellerId], [sellerId, buyerId]])
          .limit(1)
          .get();

        if (!querySnapshot.empty) {
            const convoId = querySnapshot.docs[0].id;
            setConversationId(convoId);
            return convoId;
        } else {
            const newChatRef = await firestore.collection('chats').add({
                participants: [buyerId, sellerId],
                propertyId: property.id,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastMessage: null
            });
            setConversationId(newChatRef.id);
            return newChatRef.id;
        }
    };


    const handleSendMessage = async (e) => {
        e.preventDefault();
        if (newMessage.trim() === '' || loading) return;
        
        setLoading(true);
        const convoId = await findOrCreateConversation();
        if (!convoId) { 
             console.error("Could not find or create conversation. Property may be unavailable.");
             setLoading(false);
             return; 
        }

        const messageData = {
            text: newMessage,
            senderId: currentUser.uid,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            readBy: [currentUser.uid]
        };

        try {
            await firestore.collection('chats').doc(convoId).collection('messages').add(messageData);
            
            const chatDoc = await firestore.collection('chats').doc(convoId).get();
            if (chatDoc.exists) {
                const participants = chatDoc.data().participants;
                const recipientId = participants.find(p => p !== currentUser.uid);
                
                const updateData = { lastMessage: messageData };
                if (recipientId) {
                    updateData[`unread.${recipientId}`] = true;
                }
                await firestore.collection('chats').doc(convoId).update(updateData);
            }

            onNewMessage();
            setNewMessage('');
        } catch (error) {
            console.error("Error sending message: ", error);
        } finally {
            setLoading(false);
        }
    };

    const recipientName = recipientInfo ? recipientInfo.displayName : (property ? property.userName : 'Seller');

    return (
        <div className="fixed bottom-4 right-4 w-96 h-[500px] bg-white dark:bg-gray-800 shadow-2xl rounded-lg flex flex-col z-50 chat-widget">
            <header className="bg-blue-600 text-white p-4 flex justify-between items-center rounded-t-lg">
                <h3 className="font-bold flex items-center space-x-2">
                    <span>Chat with {recipientName || 'Seller'}</span>
                    {isRecipientOnline && <span className="w-2.5 h-2.5 bg-green-400 rounded-full" title="Online"></span>}
                </h3>
                <button onClick={onClose} className="text-xl">&times;</button>
            </header>
            <div className="flex-1 p-4 overflow-y-auto chat-messages">
                {messages.map(msg => (
                    <div key={msg.id} className={`flex mb-3 ${msg.senderId === currentUser.uid ? 'justify-end' : 'justify-start'}`}>
                        <div className={`rounded-lg px-3 pt-2 pb-2 max-w-xs relative ${msg.senderId === currentUser.uid ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-100'}`}>
                            <p className={`break-words ${msg.senderId === currentUser.uid ? 'pr-8' : ''}`}>{msg.text}</p>
                            {msg.senderId === currentUser.uid && (
                                <div className="absolute bottom-1.5 right-1.5 flex items-center">
                                    {msg.readBy && msg.readBy.length > 1 ? (
                                        // Double tick (read)
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-4 h-4 text-sky-200">
                                          <path fillRule="evenodd" d="M11.603 4.234a.75.75 0 00-1.06 1.06l5.25 5.25a.75.75 0 001.06 0l7.5-7.5a.75.75 0 10-1.06-1.06L16.5 8.879l-4.447-4.445zM4.234 11.603a.75.75 0 10-1.06 1.06l5.25 5.25a.75.75 0 001.06 0l7.5-7.5a.75.75 0 10-1.06-1.06L9.75 16.129l-4.447-4.445z" clipRule="evenodd" />
                                        </svg>
                                    ) : (
                                        // Single tick (sent/delivered)
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-4 h-4 text-gray-300">
                                          <path fillRule="evenodd" d="M19.916 4.626a.75.75 0 01.208 1.04l-9 13.5a.75.75 0 01-1.154.114l-6-6a.75.75 0 011.06-1.06l5.353 5.353 8.493-12.739a.75.75 0 011.04-.208z" clipRule="evenodd" />
                                        </svg>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                ))}
                 <div ref={messagesEndRef} />
            </div>
            <form onSubmit={handleSendMessage} className="p-4 border-t dark:border-gray-700">
                <div className="flex">
                    <input
                        type="text"
                        value={newMessage}
                        onChange={(e) => setNewMessage(e.target.value)}
                        placeholder="Type a message..."
                        className="flex-1 p-2 border rounded-l-md dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                    <button type="submit" disabled={loading} className="bg-blue-600 text-white px-4 rounded-r-md hover:bg-blue-700 disabled:bg-blue-400">
                      {loading ? '...' : 'Send'}
                    </button>
                </div>
            </form>
        </div>
    );
};

const EditProfileModal = ({ isOpen, onClose, user }) => {
    const [displayName, setDisplayName] = useState(user.displayName || '');
    const [photoURL, setPhotoURL] = useState(user.photoURL || null);
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState('');
    const [success, setSuccess] = useState('');
    const fileInputRef = useRef(null);

    useEffect(() => {
        setDisplayName(user.displayName || '');
        setPhotoURL(user.photoURL || null);
        setError('');
        setSuccess('');
    }, [user, isOpen]);

    const handleImageUpload = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        setLoading(true);
        setError('');
        setSuccess('');
        const uploadedUrl = await uploadImageToCloudinary(file);
        if (uploadedUrl) {
            setPhotoURL(uploadedUrl);
            setSuccess('Image uploaded. Save to apply changes.');
        } else {
            setError('Image upload failed.');
        }
        setLoading(false);
    };

    const handlePasswordReset = async () => {
        if(window.confirm('Are you sure you want to send a password reset email?')) {
            try {
                await auth.sendPasswordResetEmail(user.email);
                setSuccess('Password reset email sent!');
            } catch (err) {
                setError(err.message);
            }
        }
    };

    const handleProfileUpdate = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');
        setSuccess('');

        try {
            // Update Auth profile
            await user.updateProfile({ displayName, photoURL });

            // Update Firestore user document
            await firestore.collection('users').doc(user.uid).update({
                displayName,
                photoURL
            });
            
            setSuccess('Profile updated successfully!');
            setTimeout(() => {
                onClose();
                window.location.reload(); // Refresh to show updated name/pic in header
            }, 1500);

        } catch (err) {
            setError(err.message);
        } finally {
            setLoading(false);
        }
    };
    
    if (!isOpen) return null;
    
    const userInitial = displayName ? displayName.charAt(0).toUpperCase() : '?';

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
            <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md">
                <div className="flex justify-between items-center mb-6">
                    <h2 className="text-2xl font-bold">Edit Profile</h2>
                    <button onClick={onClose} className="text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 text-2xl">&times;</button>
                </div>
                
                {error && <p className="bg-red-100 text-red-700 p-3 rounded-md mb-4 text-sm dark:bg-red-900/50 dark:text-red-300">{error}</p>}
                {success && <p className="bg-green-100 text-green-700 p-3 rounded-md mb-4 text-sm dark:bg-green-900/50 dark:text-green-300">{success}</p>}
                
                <form onSubmit={handleProfileUpdate}>
                    <div className="flex flex-col items-center mb-6">
                        <input type="file" ref={fileInputRef} onChange={handleImageUpload} accept="image/*" className="hidden" />
                        <div className="relative cursor-pointer group" onClick={() => fileInputRef.current.click()}>
                            <div className="w-24 h-24 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-gray-500 dark:text-gray-400 text-4xl font-bold overflow-hidden">
                                {photoURL ? <img src={photoURL} alt="Profile" className="w-full h-full object-cover" /> : <span>{userInitial}</span>}
                            </div>
                            <div className="absolute inset-0 rounded-full bg-black bg-opacity-0 group-hover:bg-opacity-50 flex items-center justify-center profile-avatar-overlay">
                                <p className="text-white text-xs text-center opacity-0 group-hover:opacity-100">Change Photo</p>
                            </div>
                        </div>
                    </div>
                
                    <div className="space-y-4">
                        <div>
                            <label htmlFor="displayName" className="block text-sm font-medium text-gray-700 dark:text-gray-300">Full Name</label>
                            <input type="text" id="displayName" value={displayName} onChange={e => setDisplayName(e.target.value)} required className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"/>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">Email</label>
                            <p className="mt-1 text-sm text-gray-500 dark:text-gray-400">{user.email}</p>
                        </div>
                        <div>
                            <button type="button" onClick={handlePasswordReset} className="w-full text-sm text-blue-600 hover:underline dark:text-blue-400 text-left">Send Password Reset Email</button>
                        </div>
                    </div>
                    
                    <div className="flex justify-end space-x-4 mt-8">
                        <button type="button" onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500">Cancel</button>
                        <button type="submit" disabled={loading} className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-blue-400">
                            {loading ? 'Saving...' : 'Save Changes'}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};

// --- THEME TOGGLE HOOK ---
const useDarkMode = () => {
    const [isDarkMode, setIsDarkMode] = useState(() => {
        const savedMode = localStorage.getItem('darkMode');
        // Default to dark mode if user's system prefers it
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        return savedMode ? JSON.parse(savedMode) : prefersDark;
    });

    useEffect(() => {
        if (isDarkMode) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
        localStorage.setItem('darkMode', JSON.stringify(isDarkMode));
    }, [isDarkMode]);

    return [isDarkMode, setIsDarkMode];
};


const ThemeToggle = () => {
    const [isDarkMode, setIsDarkMode] = useDarkMode();

    return (
        <div className="fixed bottom-4 left-4 z-50">
            <label htmlFor="theme-toggle" className="flex items-center cursor-pointer">
                <div className="relative">
                    <input type="checkbox" id="theme-toggle" className="sr-only" checked={isDarkMode} onChange={() => setIsDarkMode(!isDarkMode)} />
                    <div className="block bg-gray-200 w-12 h-7 rounded-full toggle-bg dark:bg-gray-700"></div>
                     <div className="absolute left-1 top-1 w-5 h-5 bg-white rounded-full transition-transform duration-300 ease-in-out transform dark:translate-x-full shadow-md flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" className={`h-4 w-4 transition-opacity duration-200 ${isDarkMode ? 'opacity-100 text-gray-700' : 'opacity-0'}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                           <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                        </svg>
                        <svg xmlns="http://www.w3.org/2000/svg" className={`h-4 w-4 absolute transition-opacity duration-200 ${!isDarkMode ? 'opacity-100 text-yellow-500' : 'opacity-0'}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                           <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                    </div>
                </div>
            </label>
        </div>
    );
};


// --- MAIN APP COMPONENT ---
const App = () => {
    const [user, setUser] = useState(null);
    const [loading, setLoading] = useState(true);
    const [view, setView] = useState('home'); // 'home', 'details', 'inbox'
    const [selectedPropertyId, setSelectedPropertyId] = useState(null);
    const [selectedConversationId, setSelectedConversationId] = useState(null);
    
    const [isSellModalOpen, setSellModalOpen] = useState(false);
    const [isEditProfileModalOpen, setEditProfileModalOpen] = useState(false);
    const [propertyToEdit, setPropertyToEdit] = useState(null);

    const [chatTargetProperty, setChatTargetProperty] = useState(null);
    const [chatTargetUser, setChatTargetUser] = useState(null);
    const [hasUnread, setHasUnread] = useState(false);

    useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged(currentUser => {
            setUser(currentUser);
            setLoading(false);
        });
        return () => unsubscribe();
    }, []);

    useEffect(() => {
        if (user) {
            const userStatusDatabaseRef = database.ref('/status/' + user.uid);
            const isOfflineForDatabase = {
                state: 'offline',
                last_changed: firebase.database.ServerValue.TIMESTAMP,
            };
            const isOnlineForDatabase = {
                state: 'online',
                last_changed: firebase.database.ServerValue.TIMESTAMP,
            };
            const connectedRef = database.ref('.info/connected');
            
            const listener = connectedRef.on('value', (snapshot) => {
                if (snapshot.val() === false) {
                    return;
                };
                userStatusDatabaseRef.onDisconnect().set(isOfflineForDatabase).then(() => {
                    userStatusDatabaseRef.set(isOnlineForDatabase);
                });
            });
            
            return () => connectedRef.off('value', listener);
        }
    }, [user]);

    useEffect(() => {
        if (!user) return;
        const unsubscribe = firestore.collection('chats')
            .where('participants', 'array-contains', user.uid)
            .where(`unread.${user.uid}`, '==', true)
            .onSnapshot(snapshot => {
                setHasUnread(!snapshot.empty);
            });
        return () => unsubscribe();
    }, [user]);
    
    const handleLogout = () => {
        // The onDisconnect handler set up in the useEffect will handle
        // setting the user's status to offline when the connection is severed by signOut.
        auth.signOut();
    };

    const handleContactSeller = (property) => {
        setChatTargetProperty(property);
        setChatTargetUser({ displayName: property.userName, uid: property.userId });
        setSelectedConversationId(null);
    };
    
    const handleConversationSelect = (convoId, property, otherUser) => {
        setChatTargetProperty(property);
        setChatTargetUser(otherUser);
        setSelectedConversationId(convoId);
    };

    const handleOpenInbox = () => {
        setView('inbox');
        if (user) {
             firestore.collection('chats')
                .where('participants', 'array-contains', user.uid)
                .get()
                .then(snapshot => {
                    snapshot.forEach(doc => {
                        doc.ref.update({ [`unread.${user.uid}`]: false });
                    });
                });
        }
    };
    
    const handleOpenSellModal = () => {
        setPropertyToEdit(null);
        setSellModalOpen(true);
    };

    const handleEditProperty = (property) => {
        setPropertyToEdit(property);
        setSellModalOpen(true);
    };
    
    const handleDeleteProperty = async (property) => {
        if (window.confirm(`Are you sure you want to permanently delete "${property.title || 'this property'}"? Associated chat conversations will remain.`)) {
            try {
                // Only delete the property document. Chats will remain.
                await firestore.collection('properties').doc(property.id).delete();
            } catch (error) {
                console.error("Error deleting property:", error);
                alert("Failed to delete property. Please try again.");
            }
        }
    };

    if (loading) {
        return (
            <div className="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-900">
                <div className="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-blue-500"></div>
            </div>
        );
    }
    
    if (!user) {
        return <LoginSignUp />;
    }

    const renderContent = () => {
        switch(view) {
            case 'details':
                return <PropertyDetailsPage propertyId={selectedPropertyId} onBack={() => setView('home')} onContactSeller={handleContactSeller} />;
            case 'inbox':
                return <InboxPage onBack={() => setView('home')} onConversationSelect={handleConversationSelect} />;
            case 'home':
            default:
                return (
                    <>
                        <Hero />
                        <FeaturedProperties 
                            onContactSeller={handleContactSeller}
                            onViewDetails={(id) => { setSelectedPropertyId(id); setView('details'); }}
                            onEditProperty={handleEditProperty}
                            onDeleteProperty={handleDeleteProperty}
                        />
                        <WhyChooseUs />
                        <Footer />
                    </>
                );
        }
    };

    return (
        <div className="app">
            <Header 
                user={user} 
                onSellClick={handleOpenSellModal}
                onInboxClick={handleOpenInbox}
                hasUnreadMessages={hasUnread}
                onEditProfile={() => setEditProfileModalOpen(true)}
                onLogout={handleLogout}
            />
            {renderContent()}
            <SellPropertyModal 
                isOpen={isSellModalOpen} 
                onClose={() => setSellModalOpen(false)}
                onPropertyListed={() => {}}
                propertyToEdit={propertyToEdit}
            />
            <EditProfileModal
                isOpen={isEditProfileModalOpen}
                onClose={() => setEditProfileModalOpen(false)}
                user={user}
            />
             {chatTargetProperty && (
                <ChatWidget
                    property={chatTargetProperty}
                    recipientInfo={chatTargetUser}
                    conversationId={selectedConversationId}
                    onClose={() => {
                        setChatTargetProperty(null);
                        setChatTargetUser(null);
                    }}
                    onNewMessage={() => console.log('New message sent')}
                />
            )}
             <ThemeToggle />
        </div>
    );
};

const container = document.getElementById('root');
const root = ReactDOM.createRoot(container);
root.render(<App />);

    </script>
</body>
</html>
